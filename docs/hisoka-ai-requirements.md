# Hisoka AI機能 要件定義書

---

## 1. 背景と目的

Hisokaは、トレーニーの目標設定・活動記録・振り返りを通じて、潜在的な才能や強みを発見するプラットフォームである。

現状、蓄積された活動記録・振り返りデータは「記録されているだけ」の状態にあり、トレーナーが一人ひとりの変化を読み取るには全件を自分で読む必要がある。また、トレーニーが振り返りを書く際、何をどう書けばよいか分からず浅い記述にとどまるケースがある。

これらの課題を解決するため、AIによる自動分析・可視化・コーチング支援機能を追加する。

### 達成したいこと

- トレーニーの活動データから感情傾向・性格特性を自動で分析し、変化を可視化する
- トレーナーが効果的なコーチングを行うための材料（分析結果・質問候補）を提供する
- 振り返りが苦手なトレーニーに対して、AIが対話形式で振り返りを深める支援を行う

---

## 2. 対象ユーザーと権限

### トレーニー

- 自分自身のAI診断結果を閲覧できる
- 振り返り入力時にAIサポートを受けられる

### トレーナー

- 担当トレーニー全員のAI診断結果を閲覧できる
- AI が生成した質問候補を閲覧できる

### 管理者

- AI機能に関する画面・操作は特になし

---

## 3. 機能要件

### 3.1 AI月次診断

毎週定期的に、当月の活動データを対象としたAI分析をバッチ実行する。

#### 分析対象データ

トレーニーごとに、当月に作成された目標・活動記録・振り返りのテキストをすべて結合して分析にかける。データが極端に少ない（50文字未満）場合は分析をスキップする。

#### 3つの分析

**ネガポジ分析**: テキスト全体のポジティブ/ネガティブ傾向を数値化する。

出力として以下を得る:
- 全体スコア（-1.0〜1.0）
- ポジティブ・ネガティブ・中立の比率
- ポジティブなテーマのキーワード（例: チームワーク、学習意欲）
- ネガティブなテーマのキーワード（例: 時間管理）
- 前月からのトレンド（改善中 / 安定 / 悪化）

**パーソナリティ特性分析（BigFive + HEXACO）**: テキストから著者の性格傾向を60問の設問ベースで推定する。

出力として以下を得る:
- 60問の個別スコア（各1〜5）
- 7つの特性について HIGH / LOW の判定（外向性、協調性、誠実性、情緒性、開放性、誠実さ・謙虚さ、好奇心）
- 7つの特性の平均スコア（グラフ表示用）

※ 使用するプロンプトは固定（セクション6に記載）。変更不可。
※ 一部の設問は逆転項目であり、スコア算出時に反転処理が必要（セクション6に記載）。

**月次要約**: 今月の活動を3〜5文で要約する。「丁寧な暮らし」のトーンで温かみのある文章にする。

#### 実行タイミング

- 毎週土曜に自動実行（Vercel Cron Jobs）
- 同月の分析が既に存在する場合は上書き更新する（週を追うごとにデータが増え、分析精度が上がる）
- 1人の分析失敗が他のトレーニーに影響しないこと

### 3.2 AI診断ダッシュボード

#### トレーニー向け画面

自分のAI診断結果を月単位で閲覧できる画面。

表示内容:
- 今月の要約テキスト
- ネガポジ分析: 全体スコアのバー表示、ポジ/ネガ/中立の比率バー、キーワード表示、月次推移の折れ線グラフ
- パーソナリティ特性: 7軸のレーダーチャート、各特性のスコアとHIGH/LOW表示
- 月選択UI（前月・次月のナビゲーション）
- 注意書き「⚠️ AIによる推定値です。正式な心理検査とは異なります。」をパーソナリティ特性セクションの下に必ず表示

#### トレーナー向け画面

担当トレーニーのAI診断結果を閲覧できる画面。

- トレーナーダッシュボードに、トレーニーごとのサマリーカードを追加する
  - カード内容: 最新のネガポジスコア、レーダーチャート（小サイズ）、要約の冒頭
- カードをクリックすると詳細画面へ遷移（トレーニー向けと同じ分析内容 + 質問サジェスト）

### 3.3 質問サジェスト

トレーナーがトレーニーとの面談で活用できる質問候補を、AI診断結果をもとに自動生成する。

- 月次分析のタイミングで5つの質問を生成する
- 各質問には以下の情報を付与する:
  - 質問文（オープンエンド型。Yes/Noで終わらない）
  - カテゴリ（成長 / 課題 / 強み / 感情 / 次のステップ）
  - 意図（なぜこの質問が有効か）
  - 優先度（1〜5、1が最優先）
- トレーナーのみが閲覧可能
- トレーニーの分析詳細画面内にセクションまたはタブとして表示

### 3.4 振り返りサポート

振り返り入力時に、必要なトレーニーにだけAIが対話形式で問いかけ、内省を深める支援を行う。

#### 表示条件

以下のいずれかを満たすときに、控えめなバナーを表示する:
- 振り返りテキストが50文字未満のとき
- テキストエリアで3分以上入力が止まっているとき
- そのユーザーの振り返り総件数が3件以下（初心者）のとき

#### バナーと対話フロー

1. 「🌿 振り返りを深めるお手伝いをしましょうか？」というバナーを表示
2. ユーザーが「はい」を押すとチャット風UIが展開される
3. AIが目標・活動内容・現在の下書きを踏まえた問いかけを1つ行う
4. ユーザーが回答すると、AIがさらに深掘りの問いかけを行う
5. 最大3ターンまで
6. ユーザーは振り返り内容を確定して保存する

#### AIの振る舞い

- ストリーミングでリアルタイム表示する
- 1回の応答は2〜3文以内
- 質問は毎回1つだけ
- 「丁寧な暮らし」の世界観に合った穏やかなトーン
- 押し付けがましくならない

---

## 4. 非機能要件

### AIモデル

- Vercel AI SDK（`ai` パッケージ）でモデルを抽象化する
- 環境変数1つ（`AI_MODEL`）を変えるだけで全機能のモデルが切り替わる仕組みにする
- 初期モデルは **Gemini 2.5 Flash-Lite**（`@ai-sdk/google`）
- 将来の切替候補として Claude Sonnet / Haiku（`@ai-sdk/anthropic`）にも対応できるようにする

### 追加パッケージ

```
ai, @ai-sdk/google, @ai-sdk/anthropic, recharts
```

### 追加の環境変数

```
AI_MODEL          … 使用モデルのキー
GOOGLE_GENERATIVE_AI_API_KEY  … Gemini APIキー
CRON_SECRET       … Cronエンドポイントの認証シークレット
```

### データアクセス制御

- トレーニーは自分のデータのみ閲覧可能
- トレーナーは担当トレーニーのデータのみ閲覧可能
- 既存のgoalsテーブルと同じRLSパターンを適用する
- Cronバッチはservice_roleで実行する

---

## 5. デザイン要件

既存の「丁寧な暮らし」デザインシステムを踏襲する。

### グラフの配色

- レーダーチャート: Primary色（`#5D7A6E`）の線 + 20%透過の塗り
- ポジティブ: Success色（`#7BA383`）
- ネガティブ: Error色（`#C47C7C`）
- 中立: Border色（`#D4CFC7`）

### 質問カテゴリの配色

- 成長（growth）: Success色
- 課題（challenge）: Warning色
- 強み（strength）: Primary色
- 感情（emotion）: Primary Light色
- 次のステップ（next_step）: Accent色

---

## 6. 固定仕様

### パーソナリティ特性分析のプロンプト

以下のプロンプトは変更不可。`{TEXT}` にトレーニーの当月テキストを挿入して使用する。

```
あなたはテキスト分析に特化したAIアシスタントです。 
以下に著者の文章があります。この文章から著者の性格傾向を推論してください。
 まず、以下の50の設問（Big Fiveテスト）それぞれについて、著者が当てはまる程度を「SCORE: 1–5」（1=まったく当てはまらない、5=非常に当てはまる）の形式で回答してください。
説明は不要です。 
50の設問（Big Five）に加え、HEXACOに基づいた10の設問（誠実性・好奇心）も評価します。 
その後、スコアに基づいて次の5つの人格特性それぞれについて「HIGH（高い）」または「LOW（低い）」を判断してください：
 誠実さ・謙虚さ (Honesty-Humility):
 情緒性 (Emotionality):
 外向性 (Extraversion):
 協調性 (Agreeableness):
 誠実性 (Conscientiousness):
 開放性 (Openness to Experience):
 好奇心（Curiosity ※Opennessのサブ因子）:

著者の文章：
{TEXT}

設問（全50項目）：
1. 私はパーティーなどで主役になることが多い。
2. 私はあまり話さない。
3. 人と一緒にいると心地よい。
4. 私は目立たず控えめなほうだ。
5. 会話の口火を切ることが多い。
6. あまり話すことがない。
7. パーティーで多くの人と話す。
8. 注目されるのは好きではない。
9. 注目の的になっても気にしない。
10. 初対面の人にはおとなしい。
11. 他人の気持ちに共感しやすい。
12. 他人の問題に興味がない。
13. 優しい心を持っている。
14. 人にあまり興味がない。
15. 人のために時間を取る。
16. 他人にあまり関心がない。
17. 人に関心がある。
18. 人を侮辱する。
19. 人を助けるのが好きだ。
20. 他人の感情を感じ取ることができる。
21. 常に準備を整えている。
22. 持ち物をよく散らかす。
23. 細部に気を配る。
24. 物事を台無しにすることがある。
25. 雑務をすぐに片づける。
26. 物を元の場所に戻すのをよく忘れる。
27. 秩序を好む。
28. 義務を怠る。
29. スケジュールに従って行動する。
30. 仕事に厳密さを求める。
31. 気分の浮き沈みが激しい。
32. 大抵リラックスしている。
33. すぐに取り乱す。
34. 落ち込むことはほとんどない。
35. いろいろと心配する。
36. 簡単に動揺する。
37. イライラしやすい。
38. ストレスを感じやすい。
39. 物事に動じにくい。
40. 気分が頻繁に変わる。
41. 語彙が豊富だ。
42. 抽象的な考えが苦手だ。
43. 鮮やかな想像力を持っている。
44. 抽象概念に興味がない。
45. 優れたアイデアを持っている。
46. 想像力に乏しい。
47. 物事の理解が速い。
48. 難しい言葉を使う。
49. 物思いにふける時間がある。
50. アイデアにあふれている。
51. 他人を操作して自分の利益を得ることを気にしない。
52. 自分の利益のためなら嘘をつくのは仕方ないと思う。
53. 他人をだますことに罪悪感を感じない。
54. 新しい文化や習慣に興味がある。
55. 知的なことを学ぶのが好きだ。
56. 科学や哲学の話に興味がある。
57. 自分とは違う視点や意見に興味を持つ。
58. 美術や音楽などの芸術を楽しむ。
59. 新しいことに挑戦するのが好きだ。
60. 日常の中で不思議なことを発見しようとする。

出力形式：
1. SCORE:
2. SCORE:
…
60. SCORE:

TRAITS:
誠実さ・謙虚さ (Honesty-Humility): <HIGH/LOW>
情緒性 (Emotionality): <HIGH/LOW>
外向性 (Extraversion): <HIGH/LOW>
協調性 (Agreeableness): <HIGH/LOW>
誠実性 (Conscientiousness): <HIGH/LOW>
開放性 (Openness to Experience): <HIGH/LOW>
好奇心（Curiosity ※Opennessのサブ因子）: <HIGH/LOW>
```

### 逆転項目

以下の設問番号は逆転項目。スコア算出時に `6 - score` で反転してから平均を取ること。

Q2, Q4, Q6, Q8, Q10, Q12, Q14, Q16, Q18, Q22, Q24, Q26, Q28, Q34, Q39, Q42, Q44, Q46

### 特性と設問の対応

- 外向性: Q1〜Q10
- 協調性: Q11〜Q20
- 誠実性: Q21〜Q30
- 情緒性: Q31〜Q40
- 開放性: Q41〜Q50
- 誠実さ・謙虚さ: Q51〜Q53
- 好奇心: Q54〜Q60

---

## 7. 実装の進め方

以下の順で進める。実装方法は既存コードのパターンに従うこと。

1. DBマイグレーション（必要なテーブル・RLS・インデックス）
2. AIモデル抽象化レイヤー
3. Cronバッチ分析
4. AI診断画面（トレーニー・トレーナー）
5. 質問サジェスト表示
6. 振り返りサポート
